# SimTradeLab 统一软件架构与设计文档

**版本**: 1.0  
**状态**: 动态更新中  
**文档目标**: 本文档是 SimTradeLab 项目的 **单一事实来源 (Single Source of Truth)**，旨在统一团队对系统架构的理解，指导未来的开发工作。它融合了最新的架构设计、真实的开发进展和未来的演进路线图。

---

## 1. 架构愿景与设计原则

### 1.1 愿景

SimTradeLab 致力于成为一个 **企业级、高性能、高度可扩展的量化交易研究与实盘平台**。它通过先进的插件化架构，赋能开发者和策略师快速构建、测试和部署复杂的交易策略，同时保证系统的稳定性、安全性和可维护性。

### 1.2 设计原则

本架构遵循以下核心原则，确保设计决策的一致性与合理性：

1.  **性能优先**: 核心交易路径不应被插件逻辑阻塞，保证低延迟和高吞吐量。
2.  **PTrade 100% 兼容**: 严格遵循 `PTrade_API_Summary.md` 中定义的官方API规范，确保无缝迁移。
3.  **企业级健壮性**: 内置事件契约、配置验证、依赖管理和统一测试框架，保障生产环境的稳定可靠。
4.  **智能插件化**: 每个插件都应有明确的边界和充分的业务理由，避免滥用插件导致架构腐化。
5.  **开发友好**: 提供从项目脚手架到调试工具的完整开发生命周期支持，降低上手门槛。
6.  **动态可控**: 支持插件热插拔、配置热更新，实现系统在运行时的动态调整能力。
7.  **安全隔离**: 通过多级沙箱机制（线程、进程、容器）和权限管理，保障核心系统的安全。

---

## 2. 系统架构总览

SimTradeLab 采用经典的三层架构模型，实现了核心框架与业务逻辑的有效解耦。

```
┌─────────────────────────────────────────────────────────────┐
│                  平台适配层 (Adapter Layer)                  │
│  ┌─────────────────┐    ┌─────────────────┐                 │
│  │  PTrade适配器   │    │  其他平台适配器.. │                 │
│  │   (ptrade)      │    │  (future)       │                 │
│  └─────────────────┘    └─────────────────┘                 │
└─────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────┐
│                  核心框架层 (Core Framework)                 │
│  ┌─────────────────┐    ┌─────────────────┐                 │
│  │   核心引擎       │    │   插件管理器     │                 │
│  │   (engine)      │    │ (plugin_manager)│                 │
│  └─────────────────┘    └─────────────────┘                 │
│  ┌─────────────────┐    ┌─────────────────┐                 │
│  │   事件总线       │    │   统一配置管理器 │                 │
│  │   (event_bus)   │    │ (config_manager)│                 │
│  └─────────────────┘    └─────────────────┘                 │
└─────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────┐
│                  插件扩展层 (Plugin Layer)                   │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐    │
│  │ 数据插件   │ │ 策略插件  │  │  风控插件 │ │ 分析插件   │    │
│  └───────────┘ └───────────┘ └───────────┘ └───────────┘    │
└─────────────────────────────────────────────────────────────┘
```

-   **平台适配层**: 负责将不同交易平台（如PTrade）的API和服务，统一封装成SimTradeLab内部可识别的标准化接口。
-   **核心框架层**: 系统的基石，提供事件驱动、插件管理、配置服务等核心能力，不包含任何具体的业务逻辑。
-   **插件扩展层**: 系统的业务功能实现层，所有业务逻辑（如数据获取、策略执行、风险控制）都以插件的形式存在。

---

## 3. 核心组件深度解析

本章节将逐一剖析核心框架层的关键组件，并明确其当前状态。

### 3.1 事件总线 (Event Bus)

-   **设计目标**: 作为系统的神经中枢，实现各组件和插件之间的完全解耦和异步通信。
-   **架构实现**:
    -   **标准化事件契约**: 所有事件均遵循基于 CNCF CloudEvents 规范的 `CloudEvent` 模型 (`src/simtradelab/core/events/cloud_event.py`)，包含优先级、版本、关联ID等增强字段。
    -   **核心事件定义**: 系统级的核心事件（如插件加载、配置变更）在 `src/simtradelab/core/events/contracts.py` 中统一定义，形成了稳定的内部API。
    -   **发布/订阅机制**: 提供 `emit` 和 `subscribe` 接口，支持同步/异步派发和基于事件类型的精准订阅。
-   **当前状态**: **【✅ 已完成】**
-   **展望**: 未来可引入持久化事件存储和重放能力，用于系统调试和灾难恢复。

### 3.2 统一配置管理器 (Unified Configuration Manager)

-   **设计目标**: 解决配置管理的混乱问题，提供类型安全、经过验证的、支持动态更新的统一配置服务。
-   **架构实现**:
    -   **职责分离**: 配置管理逻辑从 `PluginManager` 中完全分离，由独立的 `PluginConfigManager` (`src/simtradelab/core/config/config_manager.py`) 负责。
    -   **Pydantic 驱动**: 所有配置均需定义为 `Pydantic` 模型 (`src/simtradelab/plugins/config/base_config.py`)，从源头保证配置的结构、类型和值正确。
    -   **编译时绑定**: 通过 `@plugin_config` 等装饰器 (`src/simtradelab/core/config/decorators.py`)，在插件类定义时即绑定其配置模型，实现编译时验证。
    -   **热更新支持**: 集成 `DynamicConfigCenter` (`src/simtradelab/plugins/config/dynamic_config_center.py`)，支持监听文件或环境变量变化，实现配置的运行时热加载。
-   **当前状态**: **【✅ 已完成】** (这是一个超越原计划的重大成就)
-   **展望**: 可集成远程配置中心（如 Consul, Etcd），以支持大规模分布式部署。

### 3.3 插件管理器 (Plugin Manager) & 生命周期

-   **设计目标**: 负责插件的整个生命周期，包括发现、注册、加载、卸载、依赖解析和状态管理。
-   **架构实现**:
    -   **生命周期控制**: `PluginManager` (`src/simtradelab/core/plugin_manager.py`) 提供了完整的 `load_plugin`, `unload_plugin`, `reload_plugin` 等接口。
    -   **依赖解析**: 通过插件清单 (`plugin_manifest.yaml`) 和依赖解析引擎 (`src/simtradelab/plugins/dependency/resolver.py`)，实现插件间的版本校验、冲突检测和拓扑排序加载。
    -   **热插拔与状态迁移**: 支持在不重启系统的情况下加载/卸载插件，并能通过 `get_state` / `set_state` 接口在重载时恢复插件运行状态。
-   **当前状态**: **【✅ 已完成】**
-   **展望**: 依赖解析引擎尚处于设计阶段，需要尽快实现。

### 3.4 可插拔回测引擎 (Pluggable Backtest Engine)

-   **设计目标**: 构建一个事件驱动、高保真、可扩展的回测引擎，能够精确模拟真实的交易环境，并提供专业的策略性能分析。
-   **核心架构**:
    -   **事件驱动**: 整个回测流程由事件（如 `MarketEvent`, `OrderEvent`, `FillEvent`, `SignalEvent`）驱动，实现核心组件的解耦。
    -   **可插拔组件**: 引擎的核心功能，包括 **投资组合管理 (Portfolio)**、**执行处理器 (Execution Handler)**、**风险管理器 (Risk Manager)** 和 **性能分析器 (Performance Analyzer)**，都应是可插拔的。
    -   **执行处理器内部插件**: 执行处理器 (`ExecutionHandler`) 内部进一步包含可插拔的 **撮合引擎 (Matcher)**、**滑点模型 (Slippage)**、**手续费模型 (Commission)** 和 **延迟模型 (Latency)**。

-   **当前状态与差距分析**: **【🚧 30% 完成度 - 架构已建立，功能待深化】**
    -   **已完成 (✅)**:
        -   **基础插件加载**: `BacktestEngine` (`src/simtradelab/backtest/engine.py`) 已实现可插拔的撮合、滑点、手续费和延迟模型的基础架构。
        -   **丰富的成本模型**: 已实现多种滑点和手续费模型 (`slippage_models.py`, `commission_models.py`)，功能完善。
    -   **未完成/待重构 (❌)**:
        -   **撮合引擎 (Matching Engine)**: 当前的 `SimpleMatchingEngine` 过于简化，仅基于K线数据撮合，无法模拟真实交易。`DepthMatchingEngine` 等高级引擎尚未实现。**这是最高优先级的重构任务。**
        -   **投资组合管理器 (Portfolio Manager)**: **完全缺失**。当前系统仅有零散的 `Fill` 记录，缺乏一个统一的模块来管理现金、仓位、市值、保证金和实时盈亏。
        -   **性能分析器 (Performance Analyzer)**: **严重不足**。当前的 `get_statistics` 方法只能提供最基础的统计，无法计算夏普比率、最大回撤、Alpha/Beta等关键性能指标。
        -   **订单类型扩展**: 仅支持市价单和限价单，缺乏对止损单、跟踪止损单、IOC/FOK等复杂订单类型的支持。
        -   **高保真模拟**: 缺乏基于订单簿（LOB）的撮合机制，无法精确模拟市场冲击和部分成交。

-   **未来演进路线 (Roadmap)**:
    1.  **实现 `Portfolio` 模块**: 引入一个核心的投资组合管理器，负责跟踪所有资产和交易活动。
    2.  **重构撮合引擎**: 废弃 `SimpleMatchingEngine`，实现一个基于订单簿的 `DepthMatchingEngine`，能够处理真实的买卖队列和部分成交。
    3.  **实现 `Performance` 模块**: 引入一个专业的性能分析模块，集成 `pyfolio` 或类似库，提供丰富的风险和收益指标分析图表。
    4.  **扩展订单类型**: 在 `Order` 数据类和撮合引擎中增加对更多高级订单类型的支持。
    5.  **引入事件驱动循环**: 将当前 `update_market_data` 的驱动方式，重构为标准的事件驱动循环，以提高系统的灵活性和可扩展性。

### 3.5 统一插件测试框架 (Unified Plugin Testing Framework)

-   **设计目标**: 简化和规范插件的测试流程，保证插件生态的质量。
-   **架构实现**:
    -   提供一个 `BasePluginTest` 测试基类 (`tests/framework/base_test.py`)。
    -   该基类使用 `pytest` 的 `fixture` 机制，预先模拟 (`Mock`) 所有核心服务（如 `EventBus`, `PluginConfigManager`），并将其注入到测试用例中。
    -   开发者编写插件测试时，只需继承该基类，即可在完全隔离的环境下对插件逻辑进行单元测试。
-   **当前状态**: **【❌ 未开始】** 这是当前最主要的短板，亟待实现。
-   **展望**: 实现后，应为所有现有插件补充基于此框架的单元测试。

---

## 4. PTrade API 兼容性规范

-   **核心原则**: `PTradeAdapter` (`src/simtradelab/adapters/ptrade/adapter.py`) 的实现必须 **100% 遵循** `docs/PTrade_API_Summary.md` 中定义的超过150个API的规范。
-   **实现方式**:
    -   **模式感知路由**: `PTradeAdapter` 内部通过 `BacktestAPIRouter` 和 `TradingAPIRouter` 区分回测和实盘模式，为上层策略代码提供统一的API视图。
    -   **API验证器**: `APIVALIDATOR` (`src/simtradelab/adapters/ptrade/api_validator.py`) 在运行时检查API调用是否符合其在生命周期函数中的使用限制（如 `order` 只能在 `{handle_data}` 中调用）。
-   **当前状态**: **【✅ 已完成】** 基础框架已搭建完毕。

---

## 5. 插件开发指南

SimTradeLab 提供了一套完整的工具链，旨在打造一个繁荣的开发者生态。

1.  **创建插件**: 使用 `cookiecutter` 模板一键生成标准插件项目骨架。
    ```bash
    cookiecutter gh:simtradelab/cookiecutter-simtradelab-plugin
    ```
2.  **定义配置**: 在 `config.py` 中使用 `Pydantic` 模型定义插件的配置。
3.  **实现逻辑**: 在 `plugin.py` 中继承 `BasePlugin` 或其子类，实现核心业务逻辑。
4.  **声明依赖**: 在 `plugin_manifest.yaml` 中清晰地声明插件的元信息、依赖关系和能力。
5.  **编写测试**: 继承 `BasePluginTest` 基类，为插件编写隔离的单元测试。
6.  **提交与发布**: 确保通过所有测试和代码质量检查后，即可发布插件。

---

## 6. 项目演进路线图

### 6.1 战略演进方向

SimTradeLab 的发展将遵循一个清晰的战略路径，确保在坚实的基础上逐步构建高级功能：

1.  **第一阶段：核心框架完善 (已完成)**: 搭建稳定、可靠、可扩展的插件化核心框架。
2.  **第二阶段：核心功能深化 (当前重点)**: 提升关键业务功能（如回测引擎）的专业性和保真度，使其达到可用于严肃研究的水平。
3.  **第三阶段：企业级特性拓展 (未来方向)**: 在核心功能完善后，逐步构建数据系统优化、监控告警、多租户支持等企业级特性。

### 6.2 详细实施计划

本架构文档作为项目的“设计蓝图”，旨在保持其稳定性。所有具体的、动态的、可执行的任务项和开发路线图，均由 **`SimTradeLab_v5_Implementation_TODO.md`** 文件统一管理。

**[➡️ 查看详细的实施TODO计划](SimTradeLab_v5_Implementation_TODO.md)**

这种职责分离确保了架构文档的长期稳定性和TODO计划的短期灵活性，是项目文档治理的最佳实践。
