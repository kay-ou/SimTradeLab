# SimTradeLab 统一软件架构与设计文档

**版本**: 1.0  
**状态**: 动态更新中  
**文档目标**: 本文档是 SimTradeLab 项目的 **单一事实来源 (Single Source of Truth)**，旨在统一团队对系统架构的理解，指导未来的开发工作。它融合了最新的架构设计、真实的开发进展和未来的演进路线图。

---

## 1. 架构愿景与设计原则

### 1.1 愿景

SimTradeLab 致力于成为一个 **企业级、高性能、高度可扩展的量化交易研究与实盘平台**。它通过先进的插件化架构，赋能开发者和策略师快速构建、测试和部署复杂的交易策略，同时保证系统的稳定性、安全性和可维护性。

### 1.2 设计原则

本架构遵循以下核心原则，确保设计决策的一致性与合理性：

1.  **性能优先**: 核心交易路径不应被插件逻辑阻塞，保证低延迟和高吞吐量。
2.  **PTrade 100% 兼容**: 严格遵循 `PTrade_API_Summary.md` 中定义的官方API规范，确保无缝迁移。
3.  **企业级健壮性**: 内置事件契约、配置验证、依赖管理和统一测试框架，保障生产环境的稳定可靠。
4.  **智能插件化**: 每个插件都应有明确的边界和充分的业务理由，避免滥用插件导致架构腐化。
5.  **开发友好**: 提供从项目脚手架到调试工具的完整开发生命周期支持，降低上手门槛。
6.  **动态可控**: 支持插件热插拔、配置热更新，实现系统在运行时的动态调整能力。
7.  **安全隔离**: 通过多级沙箱机制（线程、进程、容器）和权限管理，保障核心系统的安全。

---

## 2. 系统架构总览

SimTradeLab 采用经典的三层架构模型，实现了核心框架与业务逻辑的有效解耦。

```
┌─────────────────────────────────────────────────────────────┐
│                  平台适配层 (Adapter Layer)                  │
│  ┌─────────────────┐    ┌─────────────────┐                 │
│  │  PTrade适配器   │    │  其他平台适配器.. │                 │
│  │   (ptrade)      │    │  (future)       │                 │
│  └─────────────────┘    └─────────────────┘                 │
└─────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────┐
│                  核心框架层 (Core Framework)                 │
│  ┌─────────────────┐    ┌─────────────────┐                 │
│  │   核心引擎       │    │   插件管理器     │                 │
│  │   (engine)      │    │ (plugin_manager)│                 │
│  └─────────────────┘    └─────────────────┘                 │
│  ┌─────────────────┐    ┌─────────────────┐                 │
│  │   事件总线       │    │   统一配置管理器 │                 │
│  │   (event_bus)   │    │ (config_manager)│                 │
│  └─────────────────┘    └─────────────────┘                 │
└─────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────┐
│                  插件扩展层 (Plugin Layer)                   │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐    │
│  │ 数据插件   │ │ 策略插件  │  │  风控插件 │ │ 分析插件   │    │
│  └───────────┘ └───────────┘ └───────────┘ └───────────┘    │
└─────────────────────────────────────────────────────────────┘
```

-   **平台适配层**: 负责将不同交易平台（如PTrade）的API和服务，统一封装成SimTradeLab内部可识别的标准化接口。
-   **核心框架层**: 系统的基石，提供事件驱动、插件管理、配置服务等核心能力，不包含任何具体的业务逻辑。
-   **插件扩展层**: 系统的业务功能实现层，所有业务逻辑（如数据获取、策略执行、风险控制）都以插件的形式存在。

---

## 3. 核心组件深度解析

本章节将逐一剖析核心框架层的关键组件，并明确其当前状态。

### 3.1 事件总线 (Event Bus)

-   **设计目标**: 作为系统的神经中枢，实现各组件和插件之间的完全解耦和异步通信。
-   **架构实现**:
    -   **标准化事件契约**: 所有事件均遵循基于 CNCF CloudEvents 规范的 `CloudEvent` 模型 (`src/simtradelab/core/events/cloud_event.py`)，包含优先级、版本、关联ID等增强字段。
    -   **核心事件定义**: 系统级的核心事件（如插件加载、配置变更）在 `src/simtradelab/core/events/contracts.py` 中统一定义，形成了稳定的内部API。
    -   **发布/订阅机制**: 提供 `emit` 和 `subscribe` 接口，支持同步/异步派发和基于事件类型的精准订阅。
-   **当前状态**: **【✅ 已完成】**
-   **展望**: 未来可引入持久化事件存储和重放能力，用于系统调试和灾难恢复。

### 3.2 统一配置管理器 (Unified Configuration Manager)

-   **设计目标**: 解决配置管理的混乱问题，提供类型安全、经过验证的、支持动态更新的统一配置服务。
-   **架构实现**:
    -   **职责分离**: 配置管理逻辑从 `PluginManager` 中完全分离，由独立的 `PluginConfigManager` (`src/simtradelab/core/config/config_manager.py`) 负责。
    -   **Pydantic 驱动**: 所有配置均需定义为 `Pydantic` 模型 (`src/simtradelab/plugins/config/base_config.py`)，从源头保证配置的结构、类型和值正确。
    -   **编译时绑定**: 通过 `@plugin_config` 等装饰器 (`src/simtradelab/core/config/decorators.py`)，在插件类定义时即绑定其配置模型，实现编译时验证。
    -   **热更新支持**: 集成 `DynamicConfigCenter` (`src/simtradelab/plugins/config/dynamic_config_center.py`)，支持监听文件或环境变量变化，实现配置的运行时热加载。
-   **当前状态**: **【✅ 已完成】** (这是一个超越原计划的重大成就)
-   **展望**: 可集成远程配置中心（如 Consul, Etcd），以支持大规模分布式部署。

### 3.3 插件管理器 (Plugin Manager) & 生命周期

-   **设计目标**: 负责插件的整个生命周期，包括发现、注册、加载、卸载、依赖解析和状态管理。
-   **架构实现**:
    -   **生命周期控制**: `PluginManager` (`src/simtradelab/core/plugin_manager.py`) 提供了完整的 `load_plugin`, `unload_plugin`, `reload_plugin` 等接口。
    -   **依赖解析**: 通过插件清单 (`plugin_manifest.yaml`) 和依赖解析引擎 (`src/simtradelab/plugins/dependency/resolver.py`)，实现插件间的版本校验、冲突检测和拓扑排序加载。
    -   **热插拔与状态迁移**: 支持在不重启系统的情况下加载/卸载插件，并能通过 `get_state` / `set_state` 接口在重载时恢复插件运行状态。
-   **当前状态**: **【✅ 已完成】**
-   **展望**: 依赖解析引擎尚处于设计阶段，需要尽快实现。

### 3.4 可插拔回测引擎 (Pluggable Backtest Engine)

-   **设计目标**: 提升回测的灵活性和保真度，允许用户像搭乐高一样自由组合回测的核心模拟组件。
-   **架构实现**:
    -   将回测流程中的核心环节，如 **撮合引擎 (Matcher)**、**滑点模型 (Slippage Model)**、**手续费模型 (Commission Model)** 和 **延迟模型 (Latency Model)**，全部抽象为可独立实现的插件。
    -   `BacktestEngine` (`src/simtradelab/backtest/engine.py`) 在运行时动态加载这些组件插件，并按顺序执行回测流程。
-   **当前状态**: **【🚧 进行中】** PTrade适配器中的 `BacktestAPIRouter` 已具备雏形，但需要进一步抽象和插件化。
-   **展望**: 这是提升平台专业性的关键，应作为高优先级任务。

### 3.5 统一插件测试框架 (Unified Plugin Testing Framework)

-   **设计目标**: 简化和规范插件的测试流程，保证插件生态的质量。
-   **架构实现**:
    -   提供一个 `BasePluginTest` 测试基类 (`tests/framework/base_test.py`)。
    -   该基类使用 `pytest` 的 `fixture` 机制，预先模拟 (`Mock`) 所有核心服务（如 `EventBus`, `PluginConfigManager`），并将其注入到测试用例中。
    -   开发者编写插件测试时，只需继承该基类，即可在完全隔离的环境下对插件逻辑进行单元测试。
-   **当前状态**: **【❌ 未开始】** 这是当前最主要的短板，亟待实现。
-   **展望**: 实现后，应为所有现有插件补充基于此框架的单元测试。

---

## 4. PTrade API 兼容性规范

-   **核心原则**: `PTradeAdapter` (`src/simtradelab/adapters/ptrade/adapter.py`) 的实现必须 **100% 遵循** `docs/PTrade_API_Summary.md` 中定义的超过150个API的规范。
-   **实现方式**:
    -   **模式感知路由**: `PTradeAdapter` 内部通过 `BacktestAPIRouter` 和 `TradingAPIRouter` 区分回测和实盘模式，为上层策略代码提供统一的API视图。
    -   **API验证器**: `APIVALIDATOR` (`src/simtradelab/adapters/ptrade/api_validator.py`) 在运行时检查API调用是否符合其在生命周期函数中的使用限制（如 `order` 只能在 `{handle_data}` 中调用）。
-   **当前状态**: **【✅ 已完成】** 基础框架已搭建完毕。

---

## 5. 插件开发指南

SimTradeLab 提供了一套完整的工具链，旨在打造一个繁荣的开发者生态。

1.  **创建插件**: 使用 `cookiecutter` 模板一键生成标准插件项目骨架。
    ```bash
    cookiecutter gh:simtradelab/cookiecutter-simtradelab-plugin
    ```
2.  **定义配置**: 在 `config.py` 中使用 `Pydantic` 模型定义插件的配置。
3.  **实现逻辑**: 在 `plugin.py` 中继承 `BasePlugin` 或其子类，实现核心业务逻辑。
4.  **声明依赖**: 在 `plugin_manifest.yaml` 中清晰地声明插件的元信息、依赖关系和能力。
5.  **编写测试**: 继承 `BasePluginTest` 基类，为插件编写隔离的单元测试。
6.  **提交与发布**: 确保通过所有测试和代码质量检查后，即可发布插件。

---

## 6. 项目现状与路线图

### 6.1 当前阶段评估

**项目已成功完成核心基础设施的建设，并超预期地实现了企业级的动态配置系统，目前正处于从“框架完善”到“企业级功能开发”过渡的关键阶段。**

| 阶段 | 名称 | 完成度 | 状态 |
| :--- | :--- | :--- | :--- |
| 1-4 | 核心基础设施 (事件/配置/插件) | 100% | ✅ **已完成** |
| 5 | PTrade 兼容层 | 95% | ✅ **已完成** |
| 6 | 可插拔回测引擎 | 30% | 🚧 **进行中** |
| 7 | 统一插件测试框架 | 0% | ❌ **未开始** |
| 8 | 插件依赖管理 | 20% | 🚧 **进行中** |
| 9+ | 企业级特性 (多租户/监控) | 0% | ❌ **未开始** |

### 6.2 近期实施路线图

为确保项目健康、快速地向前推进，以下为未来1-2个月的开发路线图：

#### **第一优先级 (立即实施: 1-2周)**

-   **任务**: **完成统一插件测试框架 (`BasePluginTest`)**
-   **目标**: 补齐当前最主要的短板，为后续所有插件开发提供质量保障。
-   **验收标准**:
    1.  创建 `tests/framework/base_test.py` 文件。
    2.  实现 `BasePluginTest` 基类，并提供对核心服务的模拟。
    3.  为至少一个现有插件（如 `akshare_data_plugin`）提供基于新框架的测试用例作为示范。

#### **第二优先级 (短期目标: 3-4周)**

-   **任务**: **实现可插拔回测引擎**
-   **目标**: 将 `BacktestAPIRouter` 中的逻辑完全插件化，提升回测的专业性和灵活性。
-   **验收标准**:
    1.  定义 `BaseMatcher`, `BaseSlippageModel`, `BaseCommissionModel` 等插件基类。
    2.  `BacktestEngine` 能够动态加载这些插件。
    3.  提供至少两种滑点和手续费模型实现。

#### **第三优先级 (中期目标: 1-2个月)**

-   **任务**: **完成插件依赖解析引擎**
-   **目标**: 实现 `DependencyResolver`，为插件市场的建立奠定基础。
-   **验收标准**:
    1.  能够正确解析插件间的版本依赖。
    2.  能够检测并报告依赖冲突和循环依赖。
    3.  `PluginManager` 在加载插件前调用解析器，并按拓扑顺序加载。
